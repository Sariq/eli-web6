/*
  filename: angular.integralui.treeview.min.js
  version : 1.1.003
  Copyright © 2014-2015 Lidor Systems. All rights reserved.

  This file is part of the "IntegralUI" Library. 
                                                                   
  The contents of this file are subject to the IntegralUI Studio for Web License, and may not be used except in compliance with the License.
  A copy of the License should have been installed in the product's root installation directory or it can be found at
  http://www.lidorsystems.com/products/web/studio/license-agreement.aspx.
                                                            
  This SOFTWARE is provided "AS IS", WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for the specific language 
  governing rights and limitations under the License. Any infringement will be prosecuted under applicable laws.                           
*/
angular.module("integralui").factory("IntegralUITreeViewService",["$rootScope",function(d){var e=null;return{addItem:function(l,e,f){d.$broadcast(l+"-add-item",e,f)},clearItems:function(l,e){d.$broadcast(l+"-clear-items",e)},insertItemAt:function(l,e,f,B){d.$broadcast(l+"-insert-item-at",e,f,B)},insertItemBefore:function(l,e,f){d.$broadcast(l+"-insert-item-before",e,f)},insertItemAfter:function(l,e,f){d.$broadcast(l+"-insert-item-after",e,f)},removeItem:function(l,e){d.$broadcast(l+"-remove-item",e)},removeItemAt:function(l,e,f){d.$broadcast(l+"-remove-item-at",e,f)},exportToJSON:function(l,e,f,B){d.$broadcast(l+"-export-json",e,f,B);l=this.getTempData();this.clearTempData();return l?l:""},loadData:function(l,e,f,B,g){d.$broadcast(l+"-load-data",e,f,B,g)},beginLoad:function(l,e){d.$broadcast(l+"-begin-load",e)},collapse:function(l,e){d.$broadcast(l+"-collapse",e)},endLoad:function(e){d.$broadcast(e+"-end-load")},expand:function(e,k){d.$broadcast(e+"-expand",k)},toggle:function(e,k){d.$broadcast(e+"-toggle",k)},findItemById:function(e,k){d.$broadcast(e+"-find-item-by-id",k);var f=this.getTempData();this.clearTempData();return f?f:null},findItemByText:function(e,k){d.$broadcast(e+"-find-item-by-text",k);var f=this.getTempData();this.clearTempData();return f?f:null},getItemParent:function(e,k){d.$broadcast(e+"-get-item-parent",k);var f=this.getTempData();this.clearTempData();return f?f:null},focus:function(e,k){d.$broadcast(e+"-focus",k)},clearTempData:function(){e=null},ensureVisible:function(e,k){d.$broadcast(e+"-ensure-visible",k)},getTempData:function(){return e},getItemLevel:function(e,k){d.$broadcast(e+"-get-item-level",k);var f=this.getTempData();this.clearTempData();return f?f:0},getFullPath:function(e,k){d.$broadcast(e+"-get-full-path",k);var f=this.getTempData();this.clearTempData();return f?f:""},getList:function(e,k){d.$broadcast(e+"-get-list",k);var f=this.getTempData();this.clearTempData();return f?f:[]},setTempData:function(d){e=d},selectedItem:function(e,k){if(k)d.$broadcast(e+"-set-selected-item",k);else{d.$broadcast(e+"-get-selected-item");var f=this.getTempData();this.clearTempData();return f?f:null}},selectedItems:function(e){d.$broadcast(e+"-get-selected-items");e=this.getTempData();this.clearTempData();return e?e:null},getScrollPos:function(e){d.$broadcast(e+"-get-scroll-pos");e=this.getTempData();this.clearTempData();return e?e:{x:0,y:0}},setScrollPos:function(e,k){d.$broadcast(e+"-set-scroll-pos",k)},scrollTo:function(e,k,f){d.$broadcast(e+"-scroll-to",k,f)},resumeLayout:function(e){d.$broadcast(e+"-resume-layout")},suspendLayout:function(e){d.$broadcast(e+"-suspend-layout")},updateLayout:function(e){d.$broadcast(e+"-update-layout")},updateView:function(e){d.$broadcast(e+"-update-view")}}}]).controller("IntegralUITreeViewController",["$scope","$element","$timeout","$window","IntegralUIInternalService","IntegralUIDataService","IntegralUITreeViewService","IntegralUIDragDrop",function(d,e,l,k,f,B,g,h){var c=this;this.supressProcess=!1;c.options={allowAnimation:!0,allowDrag:!1,allowDrop:!0,animationSpeed:200,dataFields:{allowDrag:"allowDrag",allowDrop:"allowDrop",content:"content",dataSource:null,expanded:"expanded",hasChildren:"hasChildren",icon:"icon",id:"id",items:"items",pid:"pid",statusIcon:"statusIcon",text:"text"},hoverSelection:!1,indent:15,itemIcon:"",itemSpacing:1,labelEdit:!1,loadItem:null,pathSeparator:"\\",rtl:!1,selectedIndex:-1,selectedItem:null,selectedItems:[],selectionMode:"one",showIcons:!0,showStatusIcons:!1};d.$on(d.name+"-add-item",function(a,m,b){c.dataObj.insertAt(m,-1,b,c.itemIsAdded)});d.$on(d.name+"-clear-items",function(a,m){c.dataObj.clear(m,c.itemIsRemoved);m||c.setScrollPos({x:0,y:0})});d.$on(d.name+"-insert-item-at",function(a,m,b,d){c.dataObj.insertAt(m,b,d,c.itemIsAdded)});d.$on(d.name+"-insert-item-after",function(a,m,b){c.dataObj.insertByRef(m,b,!0,c.itemIsAdded)});d.$on(d.name+"-insert-item-before",function(a,m,b){c.dataObj.insertByRef(m,b,!1,c.itemIsAdded)});d.$on(d.name+"-remove-item",function(a,m){c.dataObj.removeAt(m,-1,null,c.itemIsRemoved)});d.$on(d.name+"-remove-item-at",function(a,m,b){c.dataObj.removeAt(null,m,b,c.itemIsRemoved)});c.itemIsAdded=function(){c.updateLayout()};c.itemIsRemoved=function(a,m,b){c.updateLayout()};var b=c.options.indent,ca=0;c.currentList=[];c.indentList=[];c.longestItem=null;c.isThereChildItems=!1;var q=function(a,m,d,e){a[c.options.dataFields.id]||(a[c.options.dataFields.id]=f.getUniqueId());d&&(a[c.options.dataFields.pid]=d);e?c.fullList.push(a):(c.currentList.push(a),c.indentList.push(m),m=a[c.options.dataFields.text].length+m/b,ca<m&&(ca=m,c.longestItem=a))};this.isThereChildItems=!1;var r=function(a,m,d,e){if(a[c.options.dataFields.items]){if(q(a,m,d,e),!e&&!c.isThereChildItems&&a[c.options.dataFields.items]&&0<a[c.options.dataFields.items].length&&(c.isThereChildItems=!0),e||(a?a[c.options.dataFields.expanded]||void 0===a[c.options.dataFields.expanded]:1))for(d=0;d<a[c.options.dataFields.items].length;d++)r(a[c.options.dataFields.items][d],m+b,a[c.options.dataFields.id],e)}else q(a,m,d,e)};c.fullList=[];this.getFullList=function(){c.fullList.length=0;for(var a=c.dataObj.getList(),b=0;b<a.length;b++)r(a[b],0,null,!0);return c.fullList};this.getCurrentList=function(){return c.currentList};this.updateCurrentList=function(){c.currentList.length=0;c.indentList.length=0;c.isThereChildItems=!1;ca=0;var a=c.dataObj.getList();if(a)for(var b=0;b<a.length;b++)r(a[b],0,null,!1)};this.getDataFields=function(a){return{content:a.content?a.content:"content",icon:a.icon?a.icon:"icon",id:a.id?a.id:"id",pid:a.pid?a.pid:"pid",objects:a.items?a.items:"items",statusIcon:a.statusIcon?a.statusIcon:"statusIcon",text:a.text?a.text:"text"}};c.dataObj=new B({objects:d.items,events:{clear:function(a){return angular.isDefined(d.events)&&d.events.clear?d.events.clear({parent:a.e.parent}):d.clear(a)},objAdded:function(a){return angular.isDefined(d.events)&&d.events.itemAdded?d.events.itemAdded({item:a.e.item}):d.itemAdded(a)},objAdding:function(a){return angular.isDefined(d.events)&&d.events.itemAdding?d.events.itemAdding({item:a.e.item}):d.itemAdding(a)},objRemoved:function(a){return angular.isDefined(d.events)&&d.events.itemRemoved?d.events.itemRemoved({item:a.e.item}):d.itemRemoved(a)},objRemoving:function(a){return angular.isDefined(d.events)&&d.events.itemRemoving?d.events.itemRemoving({item:a.e.item}):d.itemRemoving(a)}},fields:c.getDataFields(c.options.dataFields)});d.$on(d.name+"-load-data",function(a,b,d,e,f){c.loadData(b,d,e,f)});d.$on(d.name+"-export-json",function(a,b,d,e){g.setTempData(c.exportToJSON(b,d,e))});this.exportToJSON=function(a,b,d){d=d?d:null;var e=!1!==b?c.getFullList():c.dataObj.getList();a=a?a:[c.options.dataFields.allowDrag,c.options.dataFields.allowDrop,c.options.dataFields.content,c.options.dataFields.expanded,c.options.dataFields.hasChildren,c.options.dataFields.icon,c.options.dataFields.id,c.options.dataFields.pid,c.options.dataFields.statusIcon,c.options.dataFields.text];!1===b&&a.push(c.options.dataFields.items);return JSON.stringify(e,a,d)};this.loadData=function(a,b,e,ma){c.updateDataFields(e);var f=[],g=c.options.dataFields;c.dataObj.clear(b);if(a)if(!1!==ma){var h=[];a.forEach(function(a,c){var b=a[g.pid];h[b]?(h[b][g.items]||(h[b][g.items]=[]),h[a[g.id]]=a,h[b][g.items].push(a)):(h[a[g.id]]=a,f.push(a))});h.length=0}else f=a;if(b)for(b[c.options.dataFields.items]=f,a=0;a<b[c.options.dataFields.items].length;a++)b[c.options.dataFields.items][a][c.options.dataFields.pid]=b[c.options.dataFields.id];else angular.isDefined(d.items)&&(d.items=f);c.dataObj=new B({objects:d.items,events:c.dataEvents,fields:c.getDataFields(c.options.dataFields)});c.updateLayout()};this.updateDataFields=function(a){a&&(c.options.dataFields={allowDrag:a.allowDrag?a.allowDrag:"allowDrag",allowDrop:a.allowDrop?a.allowDrop:"allowDrop",content:a.content?a.content:"content",dataSource:a.dataSource,expanded:a.expanded?a.expanded:"expanded",hasChildren:a.hasChildren?a.hasChildren:"hasChildren",icon:a.icon?a.icon:"icon",id:a.id?a.id:"id",items:a.items?a.items:"items",pid:a.pid?a.pid:"pid",statusIcon:a.statusIcon?a.statusIcon:"statusIcon",text:a.text?a.text:"text"},c.dataObj&&c.dataObj.updateDataFields(c.options.dataFields))};this.updateData=function(){c.options.dataFields.dataSource&&(c.loadData(c.options.dataFields.dataSource),c.dataObj=new B({objects:d.items,events:c.dataEvents,fields:c.getDataFields(c.options.dataFields)}))};var v=!1;this.dragDropStatus=function(a){if(a)v=a;else return v};this.getDnDSource=function(a){return{text:a.dataTransfer?a.dataTransfer.getData("text"):a.originalEvent.dataTransfer?a.originalEvent.dataTransfer.getData("text"):""}};var t=angular.element('<div class="iui-drop-marker" data-element="dropmark"></div>');this.getDropMarkLine=function(){return dropMarkLine};angular.element(k).bind("dragenter",function(a){c.dropMark()});angular.element(k).bind("dragend",function(a){c.removeDropMark();c.dragIcon&&angular.element(c.dragIcon).remove();c.cancelScrollTimer()});c.getMousePos=function(a){return{x:a.pageX?a.pageX:a.originalEvent?a.originalEvent.pageX:0,y:a.pageY?a.pageY:a.originalEvent?a.originalEvent.pageY:0}};this.getTreeName=function(){return angular.isDefined(d.name)?d.name:""};e.bind("dragenter",function(a){a.preventDefault();var b=h.getData();b.source||(b.source=c.getDnDSource(a));a={sourceTree:b.sourceCtrl?b.sourceCtrl.getTreeName():"",dragItem:b.source,targetTree:c.getTreeName(),targetItem:b.target,mousePos:c.getMousePos(a)};c.callDragEnter(a)});e.bind("dragover",function(a){a.preventDefault();var b=!0;a.dataTransfer?b="none"===a.dataTransfer.effectAllowed?!1:!0:a.originalEvent&&a.originalEvent.dataTransfer&&(b="none"===a.originalEvent.dataTransfer.effectAllowed?!1:!0);if(b){a.dataTransfer?a.dataTransfer.dropEffect=c.options.allowDrop?"move":"none":a.originalEvent&&a.originalEvent.dataTransfer&&(a.originalEvent.dataTransfer.dropEffect=c.options.allowDrop?"move":"none");b=h.getData();b.source||(b.source=c.getDnDSource(a));h.setData({source:b.source,sourceCtrl:b.sourceCtrl,target:null,dropPos:-1});b={sourceTree:b.sourceCtrl?b.sourceCtrl.getTreeName():"",dragItem:b.source,targetTree:c.getTreeName(),targetItem:null,isDropAllowed:c.options.allowDrop,dropPos:-1,mousePos:c.getMousePos(a)};c.callDragOver(b);b=c.getMousePos(a);a=b.y+16;var b=b.x+20,e=c.getDropMarkWindow();e.empty();e.append("<span class='iui-drop-marker-move-end'></span><span class='iui-drop-marker-title'>"+(d.name?d.name:"TreeView")+"</span>");c.updateDropMarkElem(c.getDropMarkWindow(),{top:a,left:b});c.dropMark(!0)}});e.bind("drop",function(a){a.preventDefault();c.dropMark();var b=!0;a.dataTransfer?b="none"===a.dataTransfer.effectAllowed?!1:!0:a.originalEvent&&a.originalEvent.dataTransfer&&(b="none"===a.originalEvent.dataTransfer.effectAllowed?!1:!0);if(b&&(b=h.getData(),b.source||(b.source=c.getDnDSource(a)),b.source)){var e={sourceTree:b.sourceCtrl?b.sourceCtrl.getTreeName():"",dragItem:b.source,targetTree:c.getTreeName(),targetItem:null,isDropAllowed:c.options.allowDrop,dropPos:-1,mousePos:c.getMousePos(a)};!1!==c.callDragDrop(e)&&(c.drop(b),d.$$phase||d.$apply())}h.clearData();a.stopPropagation()});e.bind("dragleave",function(a){a.preventDefault();c.dropMark();var b=h.getData();b.source||(b.source=c.getDnDSource(a));a={sourceTree:b.sourceCtrl?b.sourceCtrl.getTreeName():"",dragItem:b.source,targetTree:c.getTreeName(),targetItem:b.target,mousePos:c.getMousePos(a)};c.callDragLeave(a);c.cancelScrollTimer()});e.bind("dragend",function(a){a.preventDefault();c.dropMark();h.getData().source||h.clearData()});e.bind("mouseleave",function(a){a.preventDefault();c.dropMark()});this.containsMousePos=function(a,b){return h.hitTest(a,b,{left:0,top:0,right:e[0].clientWidth,bottom:e[0].clientHeight})};this.isPopupActive=function(){return!1};var I=function(a,b,d,e){var f=!1;b&&(f=b.dataObj.removeAt(a,-1,null,b.itemIsRemoved));f&&(0===e?c.dataObj.insertAt(a,-1,d,c.itemIsAdded):1===e||2===e?1===e?c.dataObj.insertByRef(a,d,!1,c.itemIsAdded):c.dataObj.insertByRef(a,d,!0,c.itemIsAdded):c.dataObj.insertAt(a,-1,null,c.itemIsAdded))};this.drop=function(a){if(a&&a.sourceCtrl){a.sourceCtrl.supressProcess=!0;a.sourceCtrl.suspendLayout();c.suspendLayout();var b=a.source;if(Array.isArray(a.source)){for(var e=[],f=0;f<a.source.length;f++){for(var g=!1,h=a.sourceCtrl.dataObj.getParent(a.source[f]);h;){if(a.sourceCtrl.isItemInSelList(h)){g=!0;break}h=a.sourceCtrl.dataObj.getParent(h)}g||e.push(a.source[f])}if(0<e.length)if(b=e[e.length-1],f=a.sourceCtrl.getItemCurrentIndex(e[0]),g=a.sourceCtrl.getItemCurrentIndex(b),f<=g)for(f=0;f<e.length;f++)I(e[f],a.sourceCtrl,a.target,a.dropPos);else for(f=e.length-1;0<=f;f--)I(e[f],a.sourceCtrl,a.target,a.dropPos)}else I(a.source,a.sourceCtrl,a.target,a.dropPos);a.sourceCtrl!==c?(c.resumeLayout(),a.sourceCtrl.resumeLayout()):c.resumeLayout();a.sourceCtrl.multiSelection(!1);var k=l(function(){if(b){a.sourceCtrl.clearPrevSelection(b);c.itemSelection(b);var e=c.getElemFromItem(b);e&&(e=c.getElement(e))&&e[0].focus();d.$apply();l.cancel(k)}},1);a.sourceCtrl.supressProcess=!1}};this.isDragAllowed=function(a){return c.options.allowDrag?a&&(a[c.options.dataFields.allowDrag]||void 0===a[c.options.dataFields.allowDrag])?!0:!1:!1};this.isChildOf=function(a,b){var d=!1;if(a&&b){var e=b[c.options.dataFields.items];if(e&&0<e.length)for(var g=0;g<e.length;g++){if(f.isEqual(a[c.options.dataFields.id],e[g][c.options.dataFields.id])){d=!0;break}else d=c.isChildOf(a,e[g]);if(d)break}}return d};this.isParentOf=function(a,b){var d=c.dataObj.getParent(b);return a&&b&&d&&f.isEqual(a[c.options.dataFields.id],d[c.options.dataFields.id])?!0:!1};this.isDropAllowed=function(a,b,d){var e=c.options.allowDrop;if(e&&a&&b&&(e=b[c.options.dataFields.allowDrop]||void 0===b[c.options.dataFields.allowDrop]?!0:!1))if(Array.isArray(a))for(var g=0;g<a.length;g++){if(f.isEqual(a[g][c.options.dataFields.id],b[c.options.dataFields.id])||0===d&&c.isParentOf(b,a[g])||c.isChildOf(b,a[g])){e=!1;break}if(!e)break}else if(f.isEqual(a[c.options.dataFields.id],b[c.options.dataFields.id])||0===d&&c.isParentOf(b,a)||c.isChildOf(b,a))e=!1;return e};this.getDropMarkWindow=function(){for(var a=t,b=angular.element(document.body).children(),c=0;c<b.length;c++){var d=angular.element(b[c]);if(d[0].attributes&&d[0].attributes["data-element"]&&"dropmark"===d[0].attributes["data-element"].value){a=d;break}}return a};this.dropMark=function(a,b){b||(b=c.getDropMarkWindow());if(b){var d="none";this.options.allowDrag&&this.options.allowDrop&&(d=a?"block":"none");angular.element(b).css("display",d)}};this.updateDropMarkElem=function(a,b){a&&b&&(a.css("top",b.top+"px"),a.css("left",b.left+"px"),a.css("width",b.width+"px"))};var E=!1,C=angular.element('<input type="text" style="position:absolute" />');this.labelEditStatus=function(a){if(a)E=a;else return E};this.getEditBox=function(){return C};this.updateEditBox=function(a){C&&a&&(C.css("top",a.top+"px"),C.css("left",a.left+"px"),C.css("width",a.width+"px"))};this.callAfterCollapse=function(a){angular.isDefined(d.events)&&d.events.afterCollapse&&d.events.afterCollapse({item:a});d.afterCollapse({e:{item:a}})};this.callAfterExpand=function(a){angular.isDefined(d.events)&&d.events.afterExpand&&d.events.afterExpand({item:a});d.afterExpand({e:{item:a}})};this.callAfterEdit=function(a){angular.isDefined(d.events)&&d.events.afterLabelEdit&&d.events.afterLabelEdit({item:a});d.afterLabelEdit({e:{item:a}})};this.callAfterSelect=function(a){angular.isDefined(d.events)&&d.events.afterSelect?d.events.afterSelect({item:a}):d.afterSelect({e:{item:a}});angular.isDefined(d.events)&&d.events.selectionChanged?d.events.selectionChanged({item:a}):d.selectionChanged({e:{item:a}})};this.callBeforeCollapse=function(a){var b=!0;return b=angular.isDefined(d.events)&&d.events.beforeCollapse?d.events.beforeCollapse({item:a}):d.beforeCollapse({e:{item:a}})};this.callBeforeExpand=function(a){var b=!0;return b=angular.isDefined(d.events)&&d.events.beforeExpand?d.events.beforeExpand({item:a}):d.beforeExpand({e:{item:a}})};this.callBeforeEdit=function(a){var b=!0;return b=angular.isDefined(d.events)&&d.events.beforeLabelEdit?d.events.beforeLabelEdit({item:a}):d.beforeLabelEdit({e:{item:a}})};this.callDragEnter=function(a){angular.isDefined(d.events)&&d.events.dragEnter?d.events.dragEnter({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}):d.dragEnter({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}})};this.callDragOver=function(a){var b=!0;return b=angular.isDefined(d.events)&&d.events.dragOver?d.events.dragOver({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}):d.dragOver({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}})};this.callDragDrop=function(a){var b=!0;return b=angular.isDefined(d.events)&&d.events.dragDrop?d.events.dragDrop({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}):d.dragDrop({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}})};this.callDragLeave=function(a){angular.isDefined(d.events)&&d.events.dragLeave?d.events.dragLeave({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}):d.dragLeave({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}})};this.callItemClick=function(a,b){angular.isDefined(d.events)&&d.events.itemClick&&d.events.itemClick({item:a,mousePos:b});d.itemClick({e:{item:a,mousePos:b}})};this.callItemDblClick=function(a,b){angular.isDefined(d.events)&&d.events.itemDblClick&&d.events.itemDblClick({item:a,mousePos:b});d.itemDblclick({e:{item:a,mousePos:b}})};this.callItemHover=function(a){angular.isDefined(d.events)&&d.events.itemHover&&d.events.itemHover({item:a});d.itemHover({e:{item:a}})};this.callItemRightClick=function(a,b){angular.isDefined(d.events)&&d.events.itemRightClick&&d.events.itemRightClick({item:a,mousePos:b});d.itemRightclick({e:{item:a,mousePos:b}})};this.callKeyDown=function(a,b){angular.isDefined(d.events)&&d.events.keyDown?d.events.keyDown({event:a,item:b}):d.keyDown({e:{event:a,item:b}})};this.callKeyPress=function(a,b){angular.isDefined(d.events)&&d.events.keyPress?d.events.keyPress({event:a,item:b}):d.keyPress({e:{event:a,item:b}})};this.callKeyUp=function(a,b){angular.isDefined(d.events)&&d.events.keyUp?d.events.keyUp({event:a,item:b}):d.keyUp({e:{event:a,item:b}})};e.bind("click",function(a){1===a.which&&c.callItemClick(null,c.getMousePos(a))});e.bind("dblclick",function(a){a.preventDefault();1===a.which&&c.callItemDblClick(null,c.getMousePos(a));a.stopPropagation()});e.bind("mousedown",function(a){3===a.which&&c.callItemRightClick(null,c.getMousePos(a));a.stopPropagation()});this.toggle=function(a,b){if(a){if(a[c.options.dataFields.hasChildren]||a[c.options.dataFields.items]&&0!==a[c.options.dataFields.items].length)if(!b||!1===a[c.options.dataFields.expanded])if(!1!==b||!1!==a[c.options.dataFields.expanded]){var d=void 0!==b?b:!1!==a[c.options.dataFields.expanded]?!0:!1,e=!0,e=void 0!==b?b?c.callBeforeExpand(a):c.callBeforeCollapse(a):d?c.callBeforeCollapse(a):c.callBeforeExpand(a);!1!==e&&(e=a[c.options.dataFields.expanded],a[c.options.dataFields.expanded]=void 0!==b?b:!d,a[c.options.dataFields.expanded]?c.callAfterExpand(a):c.callAfterCollapse(a),e!==a[c.options.dataFields.expanded]&&c.updateLayout())}}else{c.suspendLayout();d=c.getFullList();for(e=0;e<d.length;e++)c.toggle(d[e],b);c.resumeLayout()}};d.$on(d.name+"-begin-load",function(a,b){c.options.loadItem=b});d.$on(d.name+"-collapse",function(a,b){c.toggle(b,!1)});d.$on(d.name+"-end-load",function(a){c.options.loadItem=null});d.$on(d.name+"-expand",function(a,b){c.toggle(b,!0)});d.$on(d.name+"-toggle",function(a,b){c.toggle(b)});this.getTabIndex=function(){return e[0].attributes&&e[0].attributes.tabindex?e[0].attributes.tabindex.value:""};this.updateFocus=function(a){var b=l(function(){if(a){var d=c.getElemFromItem(a);d&&(d=c.getElement(d))&&d[0].focus()}else e[0].focus();l.cancel(b)},5)};d.$on(d.name+"-focus",function(a,b){c.updateFocus(b)});var J=!1;this.getElement=function(a,b){var c=null;b||(b="content");if(a)for(var d=a.children(),e=0;e<d.length;e++){var f=angular.element(d.eq(e));if(f[0].attributes&&f[0].attributes["data-element"]&&f[0].attributes["data-element"].value===b){c=f;break}}return c};this.getElemFromItem=function(a){var b=null;if(a){a=c.getItemCurrentIndex(a);var d=e.find("li");if(d&&0<d.length)for(var f=0;f<d.length;f++){var g=angular.element(d[f]);if(g[0].attributes["data-index"]&&g[0].attributes["data-index"].value.toString()===a.toString()){b=g;break}}}return b};this.getIndent=function(a){var b=0;if(a)for(parent=c.dataObj.getParent(a);parent;)b+=c.options.indent,parent=c.dataObj.getParent(parent);return b};this.getItemCurrentIndex=function(a){return a&&c.currentList?c.currentList.indexOf(a):-1};this.getItemFromChildElem=function(a){return a?(a=angular.element(a))?c.getItemFromElem(a[0].parentElement):null:null};this.getItemFromElem=function(a){if(a&&(a=angular.element(a))&&a[0].attributes["data-index"]&&(a=a[0].attributes["data-index"].value,c.isIndexInRange(a)))return c.currentList[a]};this.isIndexInRange=function(a){return 0<=a&&a<c.currentList.length};this.isItemEnabled=function(a){return f.isEnabled(a[c.options.dataFields.enabled])};this.mouseButtonStatus=function(a){J=a};d.$on(d.name+"-ensure-visible",function(a,b){c.ensureVisible(b)});d.$on(d.name+"-find-item-by-id",function(a,b){g.setTempData(c.findItemById(b))});d.$on(d.name+"-find-item-by-text",function(a,b){g.setTempData(c.findItemByText(b))});d.$on(d.name+"-get-full-path",function(a,b){g.setTempData(c.getFullPath(b))});d.$on(d.name+"-get-item-level",function(a,b){g.setTempData(c.getLevel(b))});d.$on(d.name+"-get-item-parent",function(a,b){g.setTempData(c.getParent(b))});d.$on(d.name+"-get-list",function(a,b){g.setTempData(c.getList(b))});this.ensureVisible=function(a){if(a){c.suspendLayout();for(var b=[],d=c.getParent(a);d;)b.push(d),d=c.getParent(d);for(d=b.length-1;0<=d;d--)c.toggle(b[d],!0);c.resumeLayout();c.scrollTo(a,"center")}};this.findItemById=function(a){return c.dataObj.findObjectById(a)};this.findItemByText=function(a){var b=c.dataObj.getList();return c.dataObj.searchObj(b,a,"text")};this.getFullPath=function(a){var b="";if(a)for(b=a[c.options.dataFields.text],a=c.getParent(a);a;)b=[a[c.options.dataFields.text],c.options.pathSeparator,b].join(""),a=c.getParent(a);return b};this.getLevel=function(a){var b=0;for(a=this.getParent(a);a;)b++,a=this.getParent(a);return b};this.getParent=function(a){return c.dataObj.getParent(a)};this.getList=function(a){return c.dataObj.getList(a)};this.getFirstItem=function(){for(var a=null,b=0;b<c.currentList.length;b++)if(f.isEnabled(c.currentList[b][c.options.dataFields.enabled])){a=c.currentList[b];break}return a};this.getPrevItem=function(a){var b=null;if(0<=a&&a<c.currentList.length)for(--a;0<=a;a--)if(f.isEnabled(c.currentList[a][c.options.dataFields.enabled])){b=c.currentList[a];break}return b};this.getNextItem=function(a){var b=null;for(a+=1;a<c.currentList.length;a++)if(f.isEnabled(c.currentList[a][c.options.dataFields.enabled])){b=c.currentList[a];break}return b};this.getLastItem=function(){for(var a=null,b=c.currentList.length-1;0<=b;b--)if(f.isEnabled(c.currentList[b][c.options.dataFields.enabled])){a=c.currentList[b];break}return a};this.updateSelectionStatus=function(a){switch(a){case "shift":switch(c.options.selectionMode){case "multi-simple":c.multiSelection(!0);c.shiftKeyStatus(!1);break;case "multi-extended":c.multiSelection(!0);c.shiftKeyStatus(!0);break;default:c.multiSelection(!1),c.shiftKeyStatus(!1)}break;case "ctrl":switch(c.options.selectionMode){case "multi-simple":c.multiSelection(!0);break;case "multi-extended":c.multiSelection(!0);break;default:c.multiSelection(!1)}}};e.bind("keydown",function(a){switch(a.keyCode){case 16:c.updateSelectionStatus("shift");break;case 17:c.updateSelectionStatus("ctrl")}});c.allowUpdate=!0;this.suspendLayout=function(){c.allowUpdate=!1};this.resumeLayout=function(){c.allowUpdate=!0;c.updateLayout()};d.$on(d.name+"-resume-layout",function(a){c.resumeLayout()});d.$on(d.name+"-suspend-layout",function(a){c.suspendLayout()});d.$on(d.name+"-update-layout",function(a){c.updateLayout()});d.$on(d.name+"-update-view",function(a){c.updateView()});d.$on(d.name+"-get-scroll-pos",function(a){g.setTempData(c.getScrollPos())});d.$on(d.name+"-set-scroll-pos",function(a,b){c.setScrollPos(b)});d.$on(d.name+"-scroll-to",function(a,b,d){c.scrollTo(b,d)});var w=!1,M=!1;this.shiftKeyStatus=function(a){if(void 0!=a)w=a;else return w};this.multiSelection=function(a){if(void 0!=a)M=a;else return M};this.isItemSelected=function(a){return f.isSelected(a)};this.clearPrevSelection=function(a){for(var b=0;b<c.options.selectedItems.length;b++)a&&!f.isEqual(c.options.selectedItems[b][c.options.dataFields.id],a[c.options.dataFields.id])?c.options.selectedItems[b].selected=!1:a||(c.options.selectedItems[b].selected=!1);c.options.selectedItems.length=0;a&&c.options.selectedItems.push(a);if((a=e.find("li"))&&0<a.length)for(b=0;b<a.length;b++)U(angular.element(a[b]))};this.itemSelection=function(a,b){if(a){if("none"!==c.options.selectionMode){var e=c.itemSelection(),g=!0;e&&(g=!f.isEqual(e[c.options.dataFields.id],a[c.options.dataFields.id]));var h=!0,h=angular.isDefined(d.events)&&d.events.beforeSelect?d.events.beforeSelect({item:a}):d.beforeSelect({e:{item:a}});if(!1!==h)if(g){g=!0;"multi-extended"===c.options.selectionMode&&(g=!c.isItemInSelList(a));g&&(J&&w?c.clearPrevSelection():M||"multi-simple"===c.options.selectionMode||c.clearPrevSelection());c.options.selectedItem=a;if(J&&w){if(g=c.getItemCurrentIndex(e),e=c.getItemCurrentIndex(a),g>e&&(h=g,g=e,e=h),c.isIndexInRange(g)&&c.isIndexInRange(e))for(;g<=e;g++)c.currentList[g].selected=!0,c.options.selectedItems.push(c.currentList[g])}else J&&(M||"multi-simple"===c.options.selectionMode)?(e=null===a.selected||"undefined"===a.selected?!1:a.selected,a.selected=!e,a.selected?c.isItemInSelList(a)||c.options.selectedItems.push(a):c.options.selectedItems=c.options.selectedItems.filter(function(b){return b!=a})):(a.selected=!0,c.isItemInSelList(a)||c.options.selectedItems.push(a));angular.isDefined(d.selectedItem)&&(d.selectedItem=a);c.callAfterSelect(a);c.markSelItems()}else if(M||"multi-simple"===c.options.selectionMode)e=null===a.selected||"undefined"===a.selected?!1:a.selected,b&&"undefined"!==b&&(e=b),a.selected=!e,a.selected?c.isItemInSelList(a)||c.options.selectedItems.push(a):(c.options.selectedItems=c.options.selectedItems.filter(function(b){return b!=a}),U(c.getElemFromItem(a))),c.callAfterSelect(a),c.markSelItems()}}else return c.options.selectedItem};this.updateSelection=function(a){"multi-simple"!==c.options.selectionMode&&0<c.options.selectedItems.length&&!w&&!M&&c.clearPrevSelection(a)};this.selectFirstItem=function(){for(var a=null,b=0;b<c.currentList.length;b++)if(c.isItemEnabled(c.currentList[b])){a=c.currentList[b];break}this.itemSelection(a);return c.options.selectedItem};this.isItemInSelList=function(a){var b=!1,d=c.options.selectedItems;if(a&&d)for(var e=0;e<d.length;e++)if(f.isEqual(d[e][c.options.dataFields.id],a[c.options.dataFields.id])){b=!0;break}return b};var U=function(a){var b=c.getItemFromElem(a);b&&(a=c.getElement(a))&&(c.isItemInSelList(b)?a.addClass("iui-treeview-item-content-selected"):a.removeClass("iui-treeview-item-content-selected"))};this.markSelItems=function(){var a=e.find("li");if(a&&0<a.length)for(var b=0;b<a.length;b++)U(angular.element(a[b]))};d.$on(d.name+"-get-selected-item",function(a){g.setTempData(c.itemSelection())});d.$on(d.name+"-set-selected-item",function(a,b){c.itemSelection(b)});d.$on(d.name+"-get-selected-items",function(a){g.setTempData(c.options.selectedItems)});d.$watch("options.allowDrag",function(a,b){a!==b&&(c.options.allowDrag=a,c.updateView())});d.$watch("allowDrag",function(a,b){a!==b&&(c.options.allowDrag=a,c.updateView())});d.$watch("options.allowDrop",function(a,b){a!==b&&(c.options.allowDrop=a,c.updateView())});d.$watch("allowDrop",function(a,b){a!==b&&(c.options.allowDrop=a,c.updateView())});d.$watch("options.dataFields",function(a,b){a!==b&&(c.updateDataFields(a),c.UpdateData())});d.$watch("fields",function(a,b){a!==b&&(c.options.dataFields=a,c.UpdateData())});d.$watch("options.hoverSelection",function(a,b){a!==b&&(c.options.hoverSelection=a)});d.$watch("hoverSelection",function(a,b){a!==b&&(c.options.hoverSelection=a)});d.$watch("options.itemIcon",function(a,b){a!==b&&(c.options.itemIcon=a,c.updateLayout())});d.$watch("itemIcon",function(a,b){a!==b&&(c.options.itemIcon=a,c.updateLayout())});d.$watch("options.labelEdit",function(a,b){a!==b&&(c.options.labelEdit=a)});d.$watch("labelEdit",function(a,b){a!==b&&(c.options.labelEdit=a)});d.$watch("options.pathSeparator",function(a,b){a!==b&&(c.options.pathSeparator=a)});d.$watch("pathSeparator",function(a,b){a!==b&&(c.options.pathSeparator=a)});d.$watch("options.rtl",function(a,b){a!==b&&(c.options.rtl=a,c.updateLayout())});d.$watch("rtl",function(a,b){a!==b&&(c.options.rtl=a,c.updateLayout())});c.resetSelection=function(){switch(c.options.selectionMode){case "none":c.clearPrevSelection();break;default:c.clearPrevSelection(c.itemSelection())}};d.$watch("options.selectionMode",function(a,b){a!==b&&(c.options.selectionMode=a,c.resetSelection())});d.$watch("selectionMode",function(a,b){a!==b&&(c.options.selectionMode=a,c.resetSelection())});d.$watch("options.showIcons",function(a,b){a!==b&&(c.options.showIcons=a,c.updateLayout())});d.$watch("showIcons",function(a,b){a!==b&&(c.options.showIcons=a,c.updateLayout())});d.$watch("options.showStatusIcons",function(a,b){a!==b&&(c.options.showStatusIcons=a,c.updateLayout())});d.$watch("showStatusIcons",function(a,b){a!==b&&(c.options.showStatusIcons=a,c.updateLayout())});d.$watch("options.selectedItem",function(a,b){a!==b&&(b&&(b.selected=!1),c.options.selectedItem=a,c.callAfterSelect(a))});d.$watch("selectedItem",function(a,b){a!==b&&(b&&(b.selected=!1),c.options.selectedItem=a,c.callAfterSelect(a))})}]).directive("iuiTreeview",["$compile","$timeout","$interval","IntegralUIInternalService","IntegralUIDragDrop","$window",function(d,e,l,k,f,B){return{restrict:"EA",controller:"IntegralUITreeViewController",transclude:!0,replace:!0,template:'<div class="iui-treeview" data-element="treeview"><ul class="iui-treeview-block"></ul></div>',scope:{allowAnimation:"=",allowDrag:"=",allowDrop:"=",animationSpeed:"=",fields:"=",hoverSelection:"=",itemIcon:"=",items:"=",labelEdit:"=",name:"@",options:"=?",pathSeparator:"@",rtl:"=",selectedIndex:"=",selectedItem:"=",selectionMode:"@",showIcons:"=",showStatusIcons:"=",afterCollapse:"&",afterExpand:"&",afterLabelEdit:"&",afterSelect:"&",beforeCollapse:"&",beforeExpand:"&",beforeLabelEdit:"&",beforeSelect:"&",clear:"&",dragDrop:"&",dragEnter:"&",dragLeave:"&",dragOver:"&",events:"=?",itemAdded:"&",itemAdding:"&",itemClick:"&",itemDblclick:"&",itemHover:"&",keyDown:"&",keyPress:"&",keyUp:"&",itemRemoved:"&",itemRemoving:"&",itemRightclick:"&",scrollposChanged:"&",selectionChanged:"&"},link:function(g,h,c,b,ca){var q=this,r=h.children().eq(0),v=angular.element('<div class="iui-scrollbar-vertical"><div class="iui-scroll-button-thumb-vertical"></div></div>'),t=angular.element('<div class="iui-scrollbar-horizontal"><div class="iui-scroll-button-thumb-horizontal"></div></div>'),I=angular.element('<div class="iui-scrollbar-corner"></div>'),E=null,C=null,J=null,w=b.getEditBox(),M=function(){var a="iui-treeview-block";b.options.showStatusIcons&&(a+=" "+a+"-shift-left");b.options.rtl&&(a+=" "+a+"-rtl");return a};g.$on("destroy",function(b){q.s2t();h.unbind("scroll mousewheel");angular.element(B).unbind("dragenter dragover dragend mousemove mouseup");w&&w.unbind("keydown blur");a();R&&R.$destroy()});h.append(b.getDropMarkWindow());b.dropMark();b.addDropMark=function(){var a;a=h[0];for(var c=null;a;){if(a===document.getElementsByTagName("body")[0]){c=a;break}a=a.offsetParent}if(a=c)angular.element(a).append(b.getDropMarkWindow()),b.dropMark()};b.removeDropMark=function(){b.getDropMarkWindow().remove()};var U=function(a){var c="";if(b.isThereChildItems||a&&a[b.options.dataFields.hasChildren])c="iui-treeview-expand-box";a&&(a[b.options.dataFields.hasChildren]||a[b.options.dataFields.items]&&0<a[b.options.dataFields.items].length)&&(b.options.loadItem&&k.isEqual(a[b.options.dataFields.id],b.options.loadItem[b.options.dataFields.id])?c+=" "+c+"-load":(c=a[b.options.dataFields.hasChildren]&&void 0===a[b.options.dataFields.expanded]?c+(" "+c+"-open"):!1!==a[b.options.dataFields.expanded]?c+(" "+c+"-close"):c+(" "+c+"-open"),!0===b.options.rtl&&(c+="-rtl")));return c},a=function(){var a=r.find("li");if(0<a.length)for(var c=0;c<a.length;c++){currentElem=angular.element(a[c]);currentElem.unbind("dragover drop dragenter dragleave dragend");var d=b.getElement(currentElem,"expandbox");d&&d.unbind("click");(d=b.getElement(currentElem))&&d.unbind("click dragstart dragover drop dragenter dragleave dblclick keydown keypress keyup mouseenter mouseleave mousedown mouseup")}},m=function(a){a&&(a.bind("dragover",function(a){if(b.isScrollBarVisible("vertical")){var c=b.getMousePos(a),d=h[0].getBoundingClientRect();c.y<d.top+25?ea(!1):c.y>d.bottom-25?ea(!0):V()}else V();a.stopPropagation()}),a.bind("dragend",function(a){a.preventDefault();b.dragDropStatus(!1);b.dropMark();f.getData().source||f.clearData()}))},va=function(a){a&&a.bind("click",function(a){var c=angular.element(this);(c=b.getItemFromChildElem(c))&&b.toggle(c);a.stopPropagation()})};b.dragIcon=document.createElement("img");b.dragIcon.width=1;var ma=function(a,c){if(a){b.isDragAllowed(c)&&a.attr("draggable",!0);var d=b.getTabIndex().toString()+(b.getItemCurrentIndex(b.getItemFromChildElem(a))+1).toString();a.attr("tabindex",d);a.bind("dragstart",function(a){f.clearData();var c=b.getItemFromChildElem(this);if(c)if(C&&(e.cancel(C),C=null),b.isDragAllowed(c)){b.dragDropStatus(!0);b.addDropMark();a.dataTransfer?(a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("text",c[b.options.dataFields.id]?c[b.options.dataFields.id].toString():"")):a.originalEvent&&a.originalEvent.dataTransfer&&(a.originalEvent.dataTransfer.effectAllowed="move",a.originalEvent.dataTransfer.setData("text",c[b.options.dataFields.id]?c[b.options.dataFields.id].toString():""));a={source:c,sourceCtrl:b};switch(b.options.selectionMode){case "multi-simple":a.source=b.options.selectedItems;break;case "multi-extended":a.source=b.options.selectedItems}f.setData(a)}else a.dataTransfer?a.dataTransfer.effectAllowed="none":a.originalEvent&&a.originalEvent.dataTransfer&&(a.originalEvent.dataTransfer.effectAllowed="none")});a.bind("dragover",function(a){var c=angular.element(this);a.preventDefault();var d=!0;a.dataTransfer?d="none"===a.dataTransfer.effectAllowed?!1:!0:a.originalEvent&&a.originalEvent.dataTransfer&&(d="none"===a.originalEvent.dataTransfer.effectAllowed?!1:!0);if(d){var e=b.getItemFromChildElem(c);if(e){var d=c[0].getBoundingClientRect(),g=angular.element(B)[0].pageXOffset,p=angular.element(B)[0].pageYOffset,n=b.getMousePos(a);n.x-=d.left+g;n.y-=d.top+p;c=f.getDropPos(n,{x:0,y:0,width:c[0].offsetWidth,height:c[0].offsetHeight});g=f.getData();d=b.isDropAllowed(g.source,e,c);p={sourceTree:g.sourceCtrl?g.sourceCtrl.getTreeName():"",dragItem:g.source,targetTree:b.getTreeName(),targetItem:e,isDropAllowed:d,dropPos:c,mousePos:b.getMousePos(a)};p=b.callDragOver(p);if(d&&!1!==p){p=b.getMousePos(a);a=p.y+16;p=p.x+20;n=b.getDropMarkWindow();n.empty();var h="iui-drop-marker-move-in";switch(c){case 1:h="iui-drop-marker-move-up";break;case 2:h="iui-drop-marker-move-down"}n.append("<span class='"+h+"'></span><span class='iui-drop-marker-title'>"+e[b.options.dataFields.text]+"</span>");b.updateDropMarkElem(b.getDropMarkWindow(),{top:a,left:p});b.dropMark(d);f.setData({source:g.source,sourceList:g.sourceList,target:e,dropPos:c})}else a.dataTransfer?a.dataTransfer.dropEffect="none":a.originalEvent&&a.originalEvent.dataTransfer&&(a.originalEvent.dataTransfer.dropEffect="none"),b.dropMark()}}});a.bind("drop",function(a){var c=angular.element(this);a.preventDefault();E&&(e.cancel(E),E=null);b.dropMark();var d=!0;a.dataTransfer?d="none"===a.dataTransfer.effectAllowed?!1:!0:a.originalEvent&&a.originalEvent.dataTransfer&&(d="none"===a.originalEvent.dataTransfer.effectAllowed?!1:!0);if(d){var p=b.getItemFromChildElem(c);if(p){var c=f.getData(),n=c.source;n||(n=b.getDnDSource(a));if(d=b.isDropAllowed(n,p,c.dropPos))b.toggle(p,!0),n&&(d={sourceTree:c.sourceCtrl?c.sourceCtrl.getTreeName():"",dragItem:n,targetTree:b.getTreeName(),targetItem:p,isDropAllowed:d,dropPos:c.dropPos,mousePos:b.getMousePos(a)},!1!==b.callDragDrop(d)&&(b.drop(c),g.$$phase||g.$apply()))}}f.clearData();a.stopPropagation()});a.bind("dragenter",function(a){a.preventDefault();var c=angular.element(this);c.addClass("iui-treeview-item-content-hovered");var d=b.getItemFromChildElem(c);if(d)var p=e(function(){E||(E=e(function(){E&&b.toggle(d,!0)},750));e.cancel(p)},1);c=f.getData();c.source||(c.source=b.getDnDSource(a));c={sourceTree:c.sourceCtrl?c.sourceCtrl.getTreeName():"",dragItem:c.source,targetTree:b.getTreeName(),targetItem:c.target,mousePos:b.getMousePos(a)};b.callDragEnter(c);a.stopPropagation()});a.bind("dragleave",function(a){a.preventDefault();angular.element(this).removeClass("iui-treeview-item-content-hovered");E&&(e.cancel(E),E=null);var c=f.getData();c.source||(c.source=b.getDnDSource(a));c={sourceTree:c.sourceCtrl?c.sourceCtrl.getTreeName():"",dragItem:c.source,targetTree:b.getTreeName(),targetItem:c.target,mousePos:b.getMousePos(a)};b.callDragLeave(c);a.stopPropagation()});a.bind("dblclick",function(a){a.preventDefault();if(1===a.which){var c=b.getItemFromChildElem(this);c&&(b.callItemDblClick(c,b.getMousePos(a)),b.toggle(c))}a.stopPropagation()});a.bind("mouseenter",function(a){angular.element(this).addClass("iui-treeview-item-content-hovered");var c=b.getItemFromChildElem(this);c&&(b.callItemHover(c),b.options.hoverSelection&&(J=e(function(){J&&b.itemSelection(c)},500)))});a.bind("mouseleave",function(a){angular.element(this).removeClass("iui-treeview-item-content-hovered");J&&(e.cancel(J),J=null)});var sa=function(a,c){a.preventDefault();focusDelayTime=0;var d=b.getItemCurrentIndex(c),p=G+K-2,p=p<b.currentList.length-1?p:b.currentList.length-1;d===p&&(b.setScrollPos({x:b.scrollPos.x,y:b.scrollPos.y+Math.floor(h[0].clientHeight/4)}),focusDelayTime=1);var f=b.getNextItem(d);if(f){b.itemSelection(f);g.$apply();var n=e(function(){b.updateFocus(f);e.cancel(n)},focusDelayTime)}},l=function(a,c){a.preventDefault();focusDelayTime=0;var d=b.getItemCurrentIndex(c),p=G;d===(0<p?p:0)&&(b.setScrollPos({x:b.scrollPos.x,y:b.scrollPos.y-Math.floor(h[0].clientHeight/4)}),focusDelayTime=1);var f=b.getPrevItem(b.getItemCurrentIndex(c));if(f){b.itemSelection(f);g.$apply();var n=e(function(){b.updateFocus(f);e.cancel(n)},focusDelayTime)}};a.bind("keydown",function(c){var d=b.getItemFromChildElem(this);if(d){var f=0;switch(c.keyCode){case 9:var n=b.currentList.length;0<n&&(c.shiftKey?k.isEqual(d[b.options.dataFields.id],b.currentList[0][b.options.dataFields.id])||l(c,d):k.isEqual(d[b.options.dataFields.id],b.currentList[n-1][b.options.dataFields.id])||sa(c,d));break;case 13:ra(a,0);break;case 16:b.updateSelectionStatus("shift");break;case 17:b.updateSelectionStatus("ctrl");break;case 33:c.preventDefault();f=b.getItemCurrentIndex(d);n=f-K;n=0<n?n:0;if(n!==f){var f=1,h=b.getPrevItem(n+1);if(h){b.scrollTo(h);b.itemSelection(h);g.$apply();var S=e(function(){b.updateFocus(h);e.cancel(S)},f)}}break;case 34:c.preventDefault();f=b.getItemCurrentIndex(d);n=f+K;n=n<b.currentList.length-1?n:b.currentList.length-1;n!==f&&(f=1,h=b.getNextItem(n-1))&&(b.scrollTo(h,"bottom"),b.itemSelection(h),g.$apply(),S=e(function(){b.updateFocus(h);e.cancel(S)},f));break;case 35:c.preventDefault();b.setScrollPos({x:b.scrollPos.x,y:D.y});var m=b.getLastItem();m&&(b.itemSelection(m),S=e(function(){b.updateFocus(m);e.cancel(S)},1));break;case 36:c.preventDefault();b.setScrollPos({x:b.scrollPos.x,y:0});var q=b.getFirstItem();q&&(b.itemSelection(q),S=e(function(){b.updateFocus(q);e.cancel(S)},1));break;case 37:c.preventDefault();d[b.options.dataFields.items]&&0<d[b.options.dataFields.items].length&&(b.toggle(d,!1),b.updateFocus(d));break;case 32:c.preventDefault();b.itemSelection(d,d.selected);g.$apply();break;case 38:l(c,d);break;case 39:c.preventDefault();d[b.options.dataFields.items]&&0<d[b.options.dataFields.items].length&&(b.toggle(d,!0),b.updateFocus(d));break;case 40:sa(c,d)}}b.callKeyDown(c,d)});a.bind("keyup",function(a){switch(a.keyCode){case 16:b.multiSelection(!1);b.shiftKeyStatus(!1);break;case 17:b.multiSelection(!1)}var c=b.getItemFromChildElem(this);b.callKeyUp(a,c)});a.bind("keypress",function(a){var c=b.getItemFromChildElem(this);b.callKeyPress(a,c)});a.bind("click",function(a){if(1===a.which){var c=b.getItemFromChildElem(this);c&&b.callItemClick(c,b.getMousePos(a))}a.stopPropagation()});a.bind("mousedown",function(a){b.mouseButtonStatus(!0);var c=b.getItemFromChildElem(this);if(c)switch(b.itemSelection(c),a.which){case 1:ra(angular.element(this));break;case 3:b.callItemRightClick(c,b.getMousePos(a))}a.stopPropagation()});a.bind("mouseup",function(a){b.mouseButtonStatus(!1);var c=b.getItemFromChildElem(this);c&&b.updateSelection(c);1===a.which&&C&&(e.cancel(C),C=null)})}},ra=function(a,c){b.options.labelEdit&&(void 0===c&&(c=500),C=e(function(){if(C)var b=e(function(){da(a,!0);e.cancel(b)},c);e.cancel(C)},c/3))},da=function(a,c){var d=b.getItemFromChildElem(a);if(d)if(c){if(!1!==b.callBeforeEdit(d)){b.labelEditStatus(!0);h.append(w);var f=a[0].offsetTop+Math.floor((a[0].offsetHeight-w[0].offsetHeight)/2)+2,l=b.scrollPos.x+a[0].offsetLeft,k=h[0].clientWidth-a[0].offsetLeft-6;u&&(k-=16);b.updateEditBox({top:f,left:l,width:k});w[0].value=d[b.options.dataFields.text];w.bind("keydown",function(c){switch(c.keyCode){case 13:d[b.options.dataFields.text]=w[0].value?w[0].value:"null";g.$apply();da(a,!1);b.updateLayout();b.updateFocus(d);break;case 27:da(a,!1)}c.stopPropagation()});w.bind("blur",function(a){da()});var m=e(function(){w[0].focus();w[0].select();e.cancel(m)},10)}}else b.labelEditStatus(!1),w.remove(),b.updateFocus(d),b.callAfterEdit(d);else b.labelEditStatus(!1),w.remove(),b.callAfterEdit()},G=0,R=null,z=100,H=0,L=0,K=0,F=0,N=0,fa=!1,X=!1,Y=9,Z=9,ga=0,O=0,T=0,aa=1,ha=0,ba=0,P=0,W=0,ia=1,y=null,A=null,x=!1,u=!1;this.scrollMousePos=null;var D={x:0,y:0},ba=0;b.updateViewSize=function(){var a=e(function(){L=0;u=x=!1;if(b.longestItem&&0<b.currentList.length){var c=b.getItemCurrentIndex(b.longestItem),d='<li class="iui-treeview-item" style="position:absolute;top:-9999px;padding-left:'+b.indentList[c]+'px">',d=d+('<span class="'+U(b.longestItem)+'"></span>'),d=d+('<span class="iui-treeview-item-content">'+b.longestItem[b.options.dataFields.text]+"</span>"),d=d+"</li>",c=angular.element(ta(c,!0));h.append(c);L=c[0].offsetWidth;d=h[0].offsetWidth-6;u&&v&&(d-=v[0].offsetWidth);L>d&&(t.unbind("mousedown"),h.append(t),t.bind("mousedown",function(a){a=k.getClientMousePos(a,this);var c=Math.floor(h[0].clientWidth);y&&(a.x<y[0].offsetLeft?b.setScrollPos({x:b.scrollPos.x-c,y:b.scrollPos.y}):a.x>y[0].offsetLeft+y[0].offsetWidth&&b.setScrollPos({x:b.scrollPos.x+c,y:b.scrollPos.y}))}),y=angular.element(t.children().eq(0)),x=!0,y.bind("mousedown",function(a){1===a.which&&(q.scrollMousePos=b.getMousePos(a),fa=!0);a.stopPropagation()}));H=c[0].offsetHeight;d=h[0].offsetHeight-6;x&&t&&(d-=t[0].offsetHeight);z=Math.floor(d/H)+1;na&&(z=b.currentList.length+1);u=!1;z<b.currentList.length+1&&(v.unbind("mousedown"),h.append(v),v.bind("mousedown",function(a){a=k.getClientMousePos(a,this);var c=Math.floor(h[0].clientHeight);A&&(a.y<A[0].offsetTop?(b.setScrollPos({x:b.scrollPos.x,y:b.scrollPos.y-c}),ea(!1,c)):a.y>A[0].offsetTop+A[0].offsetHeight&&(b.setScrollPos({x:b.scrollPos.x,y:b.scrollPos.y+c}),ea(!0,c)))}),A=angular.element(v.children().eq(0)),u=!0,A.bind("mousedown",function(a){1===a.which&&(q.scrollMousePos=b.getMousePos(a),X=!0);a.stopPropagation()}));c.remove()}x||(t.unbind("mousedown"),t.remove());u||(v.unbind("mousedown"),v.remove());x&&u?h.append(I):I.remove();e.cancel(a);!x&&0<b.scrollPos.x&&b.setScrollPos({x:0,y:b.scrollPos.y});!u&&0<b.scrollPos.y&&b.setScrollPos({x:b.scrollPos.x,y:0})},1)};var oa=function(){var a=e(function(){F=h[0].offsetWidth-6;N=h[0].offsetHeight-6;N=x?N-t[0].offsetHeight:N-4;F=u?F-v[0].offsetWidth:F-4;F<L?r.css("width",L+"px"):r.css("width",F+"px");r.css("height",N+"px");x&&(t.css("bottom","0px"),u||(F+=3),t.css("width",F+1+"px"));u&&(v.css("top","0px"),x||(N+=3),v.css("height",N+1+"px"));x&&u&&I.css("bottom","0px");!1!==b.options.rtl?(r.css("left","auto"),r.css("right","-"+(b.scrollPos.x-2).toString()+"px"),x&&(t.css("left","auto"),t.css("right","0px")),u&&(v.css("left","0px"),v.css("right","auto")),x&&u&&(I.css("left","0px"),I.css("right","auto"))):(r.css("left","-"+(b.scrollPos.x-2).toString()+"px"),r.css("right","auto"),x&&(t.css("left","0px"),t.css("right","auto")),u&&(v.css("left","auto"),v.css("right","0px")),x&&u&&(I.css("left","auto"),I.css("right","0px")));var c=e(function(){x&&F<L&&(ga=0,O=2,T=t[0].clientWidth-4,T>O&&(ga=T-O),Y=Math.floor(ga*(F-4)/L),9>Y&&(Y=9),y.css("width",Y+"px"),D.x=L-F,0>D.x&&(D.x=0),aa=D.x/(ga-Y-2));var a=b.currentList.length+1;u&&0<b.currentList.length&&z<a&&(P=2,W=v[0].clientHeight-4,ha=0,W>P&&(ha=W-P),Z=Math.floor(ha*z/a),9>Z&&(Z=9),A.css("height",Z+"px"),ia=(a-z)/(ha-Z-2),D.y=(a-z)*H,0>D.y&&(D.y=0),0==G?A.css("top",P+"px"):G+z-1==b.currentList.length&&A.css("top",W-A[0].offsetHeight+"px"));e.cancel(c)},1);e.cancel(a)},5)},ua=!1,na=!1;b.updateLayout=function(a){b.allowUpdate&&(h.removeClass("iui-treeview-block-rtl"),b.options.rtl&&h.addClass("iui-treeview-block-rtl"),r.removeClass("iui-treeview-block-shift-left iui-treeview-block-rtl"),r.addClass(M()),H=L=0,z=100,8>=h[0].offsetWidth&&(ua=!0),8>=h[0].offsetHeight&&(na=!0),ua&&na&&h.css("overflow","visible"),z=Math.floor(h[0].clientHeight/20),b.updateCurrentList(),b.updateView(a),b.updateView(a),e(function(){b.updateViewSize();b.updateViewSize();oa()},1))};var ta=function(a,c){var d='<li class="iui-treeview-item" ',d=c?d+('style="position:absolute;top:-9999px;padding-left:'+b.indentList[a]+'px"'):d+('data-index="'+a+'"');!c&&0<b.indentList[a]&&(d=b.options.rtl?d+(' style="padding-right:'+b.indentList[a]+'px"'):d+(' style="padding-left:'+b.indentList[a]+'px"'));d+=">";if(!1!==b.options.showStatusIcons){var e;e="iui-treeview-status-icon "+b.currentList[a].statusIcon;d+='<span class="'+e+'" data-element="statusicon"></span>'}d+='<span class="'+U(b.currentList[a])+'" data-element="expandbox"></span>';if(!1!==b.options.showIcons&&(b.currentList[a].icon||b.options.itemIcon)){e=b.currentList[a];var f="";e.icon?f=e.icon:b.icon&&(f=b.options.itemIcon);d+='<span class="'+f+'" data-element="icon"></span>'}b.currentList[a].content?(d=d+'<div class="iui-treeview-item-content" data-element="content">'+b.currentList[a][b.options.dataFields.content],d+="</div>"):(d+='<span class="iui-treeview-item-content" data-element="content"',!c&&b.currentList[a].contextMenu&&(d+=' iui-contextmenu menu-items="data['+a+'].contextMenu"'),d+=">",d=c?d+b.currentList[a][b.options.dataFields.text]:d+("{{data["+a+"]."+b.options.dataFields.text+"}}"),d+="</span>");return d+="</li>"};b.updateView=function(c){e(function(){fa||X||oa();a();r.empty();R&&R.$destroy();pa(!1);b.currentList.length>=z&&G+z-1>b.currentList.length&&(G=b.currentList.length-z+1);if(G<b.currentList.length){R=g.$new();R.data=b.currentList;K=0;for(var c="",c=null,e=0,f=G;f<G+z&&f<b.currentList.length;f++)c=ta(f),c=b.currentList[f].content?d(c)(g.$parent):d(c)(R),r.append(c),e+=angular.element(c)[0].offsetHeight,K++;if(0<K){f=r.find("li");if(0<f.length)for(var c=null,p=0;p<f.length;p++)c=angular.element(f[p]),m(c),va(b.getElement(c,"expandbox")),ma(b.getElement(c),b.getItemFromElem(c));f=h[0].offsetHeight-6;x&&t&&(f-=t[0].offsetHeight);H=e/K;z=Math.floor(f/H)+1;oa()}qa();b.markSelItems()}},1)};var ja=!1,Q=0,ka=null,la=.5;b.isScrollBarVisible=function(a){switch(a){case "horizontal":return x;case "vertical":return u}return x&&u};b.scrollPos={x:0,y:0};b.getScrollPos=function(){return b.scrollPos};b.setScrollPos=function(a){if(a){0>a.x&&(a.x=0);a.x>D.x&&(a.x=D.x);0>a.y&&(a.y=0);a.y>D.y&&(a.y=D.y);b.scrollPos=a;ba=Math.floor(b.scrollPos.y/(H*ia));a=0;var c=P+ba;a=!1!==b.options.rtl?Math.floor(b.scrollPos.x/aa)-(T-y[0].offsetWidth-O):Math.floor(b.scrollPos.x/aa)+O;x&&y&&y.css("left",a+"px");u&&A&&A.css("top",c+"px");qa();pa();angular.isDefined(g.events)&&g.events.scrollPosChanged?g.events.scrollPosChanged({scrollPos:b.scrollPos}):g.scrollposChanged({e:{scrollPos:b.scrollPos}})}};var ea=function(a,c,d){ja||(Q=0,ja=!0,ka=l(function(){var d=c,e=b.getScrollPos();d||(0===Q&&(Q=5),Q+=5+ia,la+=.5,d=Q+=Math.floor(la));e.y=a?e.y+d:e.y-d;b.setScrollPos(e);(0>=e.y||b.getScrollPos().y<e.y)&&V()},d?d:100))},V=function(){ja&&(ka&&(l.cancel(ka),ka=null),ja=!1,Q=0,la=.5)};b.cancelScrollTimer=function(){V()};b.scrollTo=function(a,c){if(a){var d=b.getItemCurrentIndex(a);if(b.isIndexInRange(d)){var e=0,e=d;switch(c){case "center":e=Math.floor(K/2);e=d>e?d-e:0;break;case "bottom":e=K-2,e=d>e?d-e:0}b.setScrollPos({x:b.scrollPos.x,y:e*H})}}};var qa=function(){if(r){var a=b.scrollPos.x;0>a&&(a=0);a>D.x&&(a=D.x);a=2-a;!1!==b.options.rtl?r.css("right",a+"px"):r.css("left",a+"px")}},pa=function(a){newIndex=0<H?Math.floor(b.scrollPos.y/H):0;newIndex+z-1>b.currentList.length&&(newIndex=b.currentList.length-z+1);0>newIndex&&(newIndex=0);newIndex!==G&&(G=newIndex,!1!==a&&b.updateView(!0))};h.bind("scroll",function(a){h[0].scrollTop=0;h[0].scrollLeft=0});h.bind("mousewheel",function(a){a.preventDefault();var c=0;a.wheelDelta?c=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail)):a.originalEvent&&(c=Math.max(-1,Math.min(1,a.originalEvent.wheelDelta||-a.originalEvent.detail)));b.setScrollPos({x:b.scrollPos.x,y:b.scrollPos.y+Math.floor(h[0].clientHeight/4)*c*-1})});angular.element(B).bind("dragover",function(a){V()});angular.element(B).bind("mousemove",function(a){if(fa){if(1===a.which){y[0].getBoundingClientRect();a=b.getMousePos(a);q.scrollMousePos||(q.scrollMousePos=a);var c=y[0].offsetLeft+(a.x-q.scrollMousePos.x);c<O?c=O:c+y[0].offsetWidth>T&&(c=T-y[0].offsetWidth);y.css("left",c+"px");q.scrollMousePos=a;b.scrollPos.x=!1!==b.options.rtl?parseInt((T-y[0].offsetLeft-y[0].offsetWidth)*aa,10):parseInt((y[0].offsetLeft-O)*aa,10);qa()}}else X&&1===a.which&&(A[0].getBoundingClientRect(),a=b.getMousePos(a),q.scrollMousePos||(q.scrollMousePos=a),c=A[0].offsetTop+(a.y-q.scrollMousePos.y),c<P?c=P:c+A[0].offsetHeight>W&&(c=W-A[0].offsetHeight),A.css("top",c+"px"),q.scrollMousePos=a,ba=c-P,b.scrollPos.y=Math.floor(ba*ia*H),pa())});angular.element(B).bind("mouseup",function(a){b.dropMark();X&&b.updateView();V();q.scrollMousePos=null;X=fa=!1});q=this;this.crpar=function(){return["si","tri","ver","on","al "]};this.crtr=function(a){var b};this.tpar=this.crpar();this.$tw=angular.element(this.crtr(tpar));this.tmp=300;this.twp=200*tmp;this.trActive=!1;this.trCount=0;this.trlTime=this.trId=null;this.trShowCount=0;this.animTr=function(){this.trCount++;3>this.trShowCount?(this.trCount=1,this.$tw.css("display","block"),this.$tw.css("top",h[0].scrollTop+"px"),this.$tw.css("left",h[0].scrollLeft+"px"),this.trShowCount++):(0===this.trCount%49&&(this.trShowCount=0),this.$tw.css("display","none"),this.$tw.css("top",h[0].scrollTop+"px"),this.$tw.css("left",h[0].scrollLeft+"px"))};this.s1t=function(a){this.trlTime=e(function(){q.trActive||(q.trCount=0,q.trActive=!0,q.trId=l(function(){q.animTr()},1E3))},a)};this.s2t=function(){this.trId&&(l.clear(this.trId),this.trId=null);this.trlTime&&(e.clear(this.trlTime),this.trlTime=null);this.trActive=!1;this.$tw.remove()};h.append(this.$tw);this.s1t(this.twp);angular.isDefined(g.options)?(b.options=g.options,b.updateData()):(!1===g.allowAnimation&&(b.options.allowAnimation=g.allowAnimation),!0===g.allowDrag&&(b.options.allowDrag=g.allowDrag),!1===g.allowDrop&&(b.options.allowDrop=g.allowDrop),angular.isDefined(g.animationSpeed)&&200!==g.animationSpeed&&(b.options.animationSpeed=g.animationSpeed),angular.isDefined(g.fields)&&(b.updateDataFields(g.fields),b.updateData()),!0===g.hoverSelection&&(b.options.hoverSelection=g.hoverSelection),angular.isDefined(g.itemIcon)&&(b.options.itemIcon=g.itemIcon),angular.isDefined(g.labelEdit)&&(b.options.labelEdit=g.labelEdit),!0===g.rtl&&(b.options.rtl=g.rtl),angular.isDefined(g.selectedIndex)&&(b.options.selectedIndex=g.selectedIndex),angular.isDefined(g.selectedItem)&&(b.options.selectedItem=g.selectedItem),angular.isDefined(g.selectionMode)&&(b.options.selectionMode=g.selectionMode),!1===g.showIcons&&(b.options.showIcons=g.showIcons),!0===g.showStatusIcons&&(b.options.showStatusIcons=g.showStatusIcons));b.updateLayout()}}}]);